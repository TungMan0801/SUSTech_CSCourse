# CS305 Computer Network Final Review

11910738 文颖潼 [TungMan0801](https://github.com/TungMan0801)

啊啊啊老子本来复习了好多结果文件没了，偶想似啊~~（也代表了我的知识跟着文本不跟脑子~~

只能Remake了 希望苟活过期末（；´д｀）ゞ



**声明：**

1. 本复习是基于2022S南方科技大学的CS305课程课件进行全面重点翻译，旨在让笔者从啥也不会快速remake到掌握全局知识，属于冲刺班。然而，想要更加稳当还是需要加以课后习题、查阅课本详细的解释进行动笔联系才是更好的办法！
2. 翻译为中文主要用于笔者更好的理解，而正式考试需要全英文作答。另外，本学期是疫情网课时期，无期中，所以期末考试将覆盖全部学习内容。
3. 本复习pdf对于第七章部分略过较多，请结合自己的学习情况和课程复习！
4. Review不能押题，不能保证此后教学方向和内容一致。若有错误请斧正~若您感到有帮助，请给俺留下支持！！XD



## L1 Basics Intro

#### 数据交流

两个或多个之间的数字数据传输计算机或其他主机

#### 网络 Internet

三网——电信网络，有线电视网络，计算机网络

网络融合——将三网功能融合在一起

#### 计算机网络 Computer Network

一种电信网络，允许计算机交换数据 ,最著名的是互联网(Internet)

也是一种通信基础设施，与其他两种网络不同的是计算机网络的端设备是功能强大的计算机

两个重要功能：连通Connection和共享Sharing

作用范围：广域网WAN(Wide)，城域网MAN（Metropolitan），局域网LAN(Local)，个人区域网(Personal)

#### 协议 Protocol

协议定义在网络实体之间发送和接收的消息格式、顺序，以及对邮件采取的操作传输、接收。

### Protocol Layers, service models

#### 自上而下的层次结构

1. **Application应用层 -**各种应用程序协议，比如HTTP,FTP,SMTP,POP3，为计算机用户提供接口和服务

2. **Transport传输层 -** 管理端到端的通信连接。接受上一层的数据，在必要的时候把数据进行分割，并将这些数据交给网络层保证数据段有效到达对端
3. **Network网络层 -** 数据路由，控制子网的运行，如逻辑编址、分组传输、路由选择
4. **Link数据链路层 -** 管理*相邻节点*之间的数据通信，物理寻址、同时将原始比特流转变为逻辑传输线路
5. **Physical物理层**-数据通信的光电物理特性。机械、电子、定时接口通信信道上的原始比特流传输

- 各层之间是相互独立的；每一层需要有足够的灵活性；各层之间完全解耦。每一层都实现一个服务,依靠下层提供的服务

##### 介质访问控制地址Media Access Contorl Address

每一个网络接口都有一个这个地址,由此MAC地址表记录对应关系和接口所属vlan信息。长度48bits=12位的16进制。证明身份，更多是用于确认对方信息而存在的。

MAC又分为物理、广播、组播地址。

1. MAC地址长度为6字节，48位；
2. MAC地址具有唯一性，每个网络适配器对应一个MAC地址；
3. 通常采用十六进制表示法，每个字节表示一个十六进制数，用 - 或 : 连接起来；
4. MAC广播地址：FF-FF-FF-FF-FF-FF

#### IP地址 Internet Protocol Address

每一个计算机都有自己的IP地址，相当于自己的门牌号。IP=网络地址+主机地址

```
网络地址(相当于街道地址): 192.168.100.0 
主机地址(相当于各户的门号): 0.0.0.1 
IP地址(相当于住户地址): 网络地址+主机地址=192.168.100.1 
广播地址: 192.168.100.255
```

通过IP地址的网络位可以确定某个主机所在网络的位置，从而明确一条数据传送的路径。

IP地址长度为32位=4个最大值为255（2^8-1)的十进制数字组成

这个IP地址是私有地址，是不能够直接在网络上应用的，上互联网转为公有地址。

为了让计算机可以互相通讯，他们需要处在相同的子网内。↓

#### 子网 Subnet in L1

• 192.168.0.1 and 192.168.0.2: same subnet （第三位数不同）

• 192.168.0.1 and 192.168.1.1: different subnet

可以ip地址和子网掩码（Subnet Mask）做“与”运算，找到他们的子网。

用网线直接连接的计算机或是通过HUB（集线器）或普通交换机间接的计算机之间要能够相互通,计算机必须要在同一网络（子网相同）,也就是说它们的网络地址必须相同,而且主机地址必须不一样.如果不在一个网络就无法通。

#### 子网掩码 Subnet Mask

用来判断任意两台计算机的ip地址是否属于同一子网络的根据,常见255.255.255.0

##### Ethernet(以太网)

在数据链路层和物理层上运行，维护简单，可靠，速率快，硬件便宜



#### Default Gateway 默认网关

一个房间可以有很多扇门，一台主机也可以有多个网关。一台主机如果找不到可用的网关，就会把数据包发给默认指定的网关，由这个网关来处理数据包。现在主机使用的网关，一般指的是默认网关。一定要是自己电脑所在网段中的IP地址。

可以手动设置（适用于电脑数量较少时）和自动设置（利用DHCP动态主机配置协议服务器）来自动分配ip地址，子网掩码和默认网关。

### 网络边缘 Network Edge

主机hosts: clients客户端 and servers服务端（一般在数据中心)

主机的发送功能：接受申请信息，分裂为更小的块（数据包），长度为L bits; 将包以R（又叫链路容量Capacity, link bandwidth）的传输速率传输到接入网络。

![image-20220604232504897](C:\Users\Tung\AppData\Roaming\Typora\typora-user-images\image-20220604232504897.png)

连接终端系统到边缘路由器的方式：住宅接入网，机构准入网络，移动接入网络

#### bandwidth 带宽

传输速率，位每秒

#### Network Access 网络访问

 wired, wireless communication links

Hybrid fiber coax（HFC）：混合纤维同轴电缆(cable net)

Digital subsriber line:数字用户线路(DSL

#### bandwidth 带宽

传输速率，位每秒

#### 物理媒体

bit(位，比特)：在一对传输者和接收者之间传输

Physical Link物理链接: 传输者和接受者之间的登西

Guided media引导媒体：介质

Unguided media无制导媒体：无线电

coax同轴， fiber纤维 , radio收音机

### 网络核心 Network Core

互联路由器;网络的网络

#### 分组交换：

主机将应用层信息拆分为包，将一个路由器转发到下一个路由器，从源到目的地。

以全链路容量传输的每个数据包。

#### 两个网络核心的重要功能：

**转发 Forwarding:** 本地操作，将到达的数据包从路由器的输入链路移动到适当的路由器输出链路

**路由 Routing：** 全局操作，确定数据包采用的原目标路径路由算法

#### 包切换 Packet Switching

store(存储)和forward(转发):要整个包到达路由器才能被传输到下一条链路。

适合“突发”数据，资源共享，更简单。

- [ ] #### 电路切换 circuit switching

这一段我有点没看懂。分FDM和TDM

### Performance 性能表现

#### Loss丢包: 

如果链路的到达速度超过了链路传输速率一段时间，包就会开始排队等待被传输到输出链路上。若此时memory(buffer/queue，容量有限)满了，包就被丢了。丢失的包可能会被上一个节点或系统重传，或者不传。

#### Delay延迟

**$d_{trans}$传输时延Transmission Delay**: 要用L/R秒的时间来以R速度传输L比特的包

$d_{prop}$**传播时延Propagation Delay**:要用d/s秒的时间以s的传播速度来传播d长度的物理链路

 $d_{proc}$ 节点处理时延，校验错误决定输出链路；

$d_{queue}$排队时延：在输出链路等待传输的时间，它取决于路由器的拥塞程度。

包在路由器的延迟来自这四个源头，加起来就是了。

Traceroute程序提供来自沿端到端网络路径从源头到路由器目的地时，对每一个路由器都发三个包，到达路径上的路由器i（有生存时间字段），路由器i会回发包给发送者，发送者计算这个传输和回复之间的时间间隔。

#### Throughput吞吐量:

涉及三个物理量：信道带宽，往返传播时延，发送文件的大小。最大吞吐量=文件大小/时延/带宽

从发送者到接受者发送比特的速率。有瞬时性的（给定时间点）和平均的（长时间内计算）

### Security 安全

#### 入侵手法

- 数据包拦截（Packet interception):packet sniffing
- 假身份（Fake identity）：IP spoofing:用假源地址发数据包
- 拒绝服务（Denial of Service): 攻击者通过虚假流量压倒资源使资源对合法流量不可用

#### 防御

- 认证:(authenticatioin):证明你是你所说的那个人
- 保密性(confidenticality):通过加密完整性检查:数字签名防止/检测篡改
- 访问限制(Access restrictions):受密码保护的VPN
- 防火墙（Firewalls):接入和核心中的专门“中间体” 网络

---

## L2 Application Layer 应用层

在底三层（物理、链路、网络）的基础上构建，使用底层功能提供服务。

支持网络应用(社交媒体，网页，短信，邮件……)。程序需要在不同终端系统上运行，通过网络通信。不需要编写软件网络核心设备。

### Client-Server

**服务器：**永远在线长期运行；IP永久；常在数据中心

**客户端：**联系服务端，偶尔连接，动态IP，不直接和彼此沟通（HTTP,IMAP,FTP）

有了一样的host,两个进程可以用“进程间通信”联系；否则靠交换信息（见套接字Socket）

要确定接受信息的进程身份，标识需要包括IP地址和绑定主机进程的端口号。

如果只有IP地址不行，因为同一个主机可以跑很多个进程。

### Principles of application-layer protocols 应用层协议

#### 协议中定义：

- 交换的信息类型：请求Requests或响应Response
- 消息语法：哪些字段和他们如何描述
- 消息语义：信息意义
- 规则：何时/如何进程要对信息做出发送和回应

**开放协议Open Protocols:**在RFC中定义，每个人都可以看；允许互操作；比如HTTP,SMTP

**专有协议Proprietary Protocols:**比如Skype, Zoom

##### 应用需要哪些传输层服务：

1. 数据完整性		2.计时 	3.吞吐量 	4.安全

| TCP 服务                                 | UDP 服务                             |
| ---------------------------------------- | ------------------------------------ |
| 收发者间可靠传输                         | 不可靠传输                           |
| 流控制：发送者不会压倒对方               | 不控制流                             |
| 拥塞控制：网络过载时发送器节流           | 不拥塞控制                           |
| 不计时，不做最低吞吐量保证，不保证安全性 | 不计时，不保证最低吞吐量，不保证安全 |
| 面向连接：需要在服务端和客户端间设置     | 不设置连接                           |

---

### World Wide Web: HTTP 

网页是由很多个对象组成的，存在网页服务器上。他们可以是各种文件，由URL定位。

**HTTP（Hypertext transfer protocol):超文本传输协议**

它是网页的应用层协议，客户端是那些请求、接受和播放网页对象的浏览器；服务端则为以HTTP协议发出这些对象的服务器。

**使用TCP服务的HTTP：**客户端发起TCP连接到服务端，服务端接受，HTTP信息在两者之间交换，TCP连接关闭。这个过程中，HTTP是无状态的。服务器不维护过去客户端发出的请求信息。（维护状态的协议都很复杂好吧）

两种连接：HTTP1.0一次连接最多发一个对象（非持久）；HTTP1.1可以发多个对象（持久）。

**RTT：**一个小数据包在客户端和服务端来回传输的时间

**HTTP Response Time:** 非持久HTTP的话，是2RTT+文件传输时间。一个RTT来初始化TCP连接，一个RTT用于HTTP请求和前几个要返回的HTTP响应字节数。持久HTTP的话只需要1个RTT（响应时间减半了）

#### 请求信息内容

![image-20220605051914966](C:\Users\Tung\AppData\Roaming\Typora\typora-user-images\image-20220605051914966.png)



有这些方法：GET（获取，URL包括用户信息，跟着一个问号） / POST(发送方法)/ HEAD（请求报头，需要在GET里指定URL）/PUT（上传新文件到服务器）

#### 响应信息内容

![image-20220605052309880](C:\Users\Tung\AppData\Roaming\Typora\typora-user-images\image-20220605052309880.png)

第一行的状态码很重要：100-199 信息回应；200-299成功回应；300-399重定向信息；400-499客户端错误；500-599服务端错误。

较为典型：200 OK; 301 Moved Permanently; 400 Bad Request; 404 Not found; 505 HTTP Version Not supported

#### Cookies 小甜饼（？

就是服务器暂存在你电脑里的资料，好让服务器辨认计算器。Cookies记录你的选择和文字，服务器来根据Cookie内容判断使用者来送出特定内容。他可以维护用户和服务器的状态。因为之前提到两端交互没有状态，所以没有多步交换的概念。

##### *四个组件*

1. HTTP响应消息的Cookie Header行
2. 下一个HTTP请求消息中的Cookie Header行
3. 保存在用户主机上的cookie文件，用户浏览器会管理
4. 网站后端的数据库

**哪些Cookies能被用：**授权；购物车；推荐系统；用户会话

**Cookies和隐私：**Cookies允许其他网站来了解你；第三方cookie以通用身份跨网站跟踪

#### Proxy Servers（Web Caches）代理服务器

目标：在不涉及调用原服务器时满足客户端请求

用户将浏览器配置指向一个Web缓存，浏览器发送所有HTTP请求到缓存中，如果这个已经在缓存里就时缓存将这个对象返回回去，否则缓存去向原服务端请求此对象，由缓存向客户端发回去。

它同时在C/S中扮演着两者，一般由ISP安装。好处是减少客户端的响应时间，减少链路上的流量；网上有大量缓存，这让量少的内容提供商更高效

![image-20220605060949627](C:\Users\Tung\AppData\Roaming\Typora\typora-user-images\image-20220605060949627.png)![image-20220605060959170](C:\Users\Tung\AppData\Roaming\Typora\typora-user-images\image-20220605060959170.png)

**条件Get：**当缓存里有最新缓存版时不发对象。 没有传输delay，更低的链路利用率

#### HTTP/2

目标是减少多个对象请求时的时延。 HTTP1.1在单个TCP上引入多个管道关系，服务器按顺序响应获取，FCFS调度下小对象得等大对象传输（HOL阻塞），丢失回复停止对象传播

而HTTP/2增加了服务器发对象的了灵活性，很多和前者大多相同，但是传输对象优先级不一定是FCFS，而是基于客户指定的。将未请求的对象推送到客户端，将对象再分为帧（Frame)以减轻阻塞。

后续传输层中HTTP/3有在UDP上增加安全性，对象错误和拥塞控制。

### E-mail, SMTP, IMAP

**主要组件**： 

1. 用户代理User agents：邮件阅读器，撰写编辑和阅读邮件信息，传入得消息存在服务器

2. 邮件服务器Email Servers：邮箱包含收到的邮件，传出消息列表，SMTP协议
3. 简单的邮件传输协议SMTP：使用TCP可靠地从客户端传输电子邮件到服务端；三个阶段：握手，传输，关闭；用命令/响应交互

HTTP对象都封装在自己的相应消息中，而SMTP在多个消息中发送多个对象。SMTP持久连接，需要消息为7位Ascii，使用CRLF.CRLF决定消息结束符。

邮件访问协议：从服务器检索

**IMAP(Internet Mail Access Protocol):**存储在服务器上的邮件，IMAP提供检索删除和文件夹

和邮件收发有关的协议：SMTP,	IMAP，POP3

---

### The Domain Name System(DNS)域名系统

DNS是一个分布式的、分层的数据库。非常非常重要！就像网络世界地图

主机和路由器有IP地址和名字来做身份证明，那么IP地址和名字怎么相互映射？

在许多名称服务器的层次结构实现了分布式数据库；应用层协议：主机、名称服务器交流来解码地址与名字的翻译。

#### DNS的服务

- 主机名到IP地址的转换
- 主机命名规范
- 邮件服务器命名
- 负载分布，复制web服务器：多个IP对应一个名字

比如说你访问www.sustech.edu.cn， （如果电脑的DNS没有缓存记录、HOST文件没有映射关系、互联网线路供应商本地DNS服务器没有缓存记录，那么）客户端先访问根域名服务器找.cn的DNS服务器，然后找它要edu.cn的DNS服务器，再找它要sustech.edu.cn的DNS服务器，最后找到www.sustech.edu.cn的IP地址，返回给本地DNS服务器，回复给电脑。

DNS缓存可以提高查询效率，但是当域名和IP地址映射关系发生变化时，或者缓存的IP地址对应的服务器故障时，使用DNS缓存就不能正常访问网站了，因此DNS缓存默认也是有时间限制TTL的。

**根域名服务器**：非常非常重要，官方级，最终联系人

**TLD顶级域名服务器：**为这些负责.com, .org, .net, .edu, .aero, .jobs, .museums, and all top-level country domains, e.g.: .cn, .uk, .fr, .ca, .jp

**权威DNS服务器：**组织自己的DNS服务器，提供权威主机名到IP的映射，可被组织维护

**本地DNS服务器：**其实不属于层次结构，每一个ISP有一个，主机发DNS查询就会送到这

#### DNS域名解析

1. 迭代查询：联系的服务器如果不知道就会回另一个可联系的服务器
2. 递归查询：让域名解析的负担放联系服务器上

#### DNS记录

存储资源记录的分布式数据（RR格式：name, value, type, ttl）

**Type=A:** `name`: hostname，`value`:IP address

**Type=NS: **`name`:domain, `value`: hostname of authoritative name server for this domain

**Type=CNAME** `name`:alias name for canonical name, `value`:canonical name

**Type=MX:** `value`: name of mailserver associated with `name`

![image-20220605073118411](C:\Users\Tung\AppData\Roaming\Typora\typora-user-images\image-20220605073118411.png)

#### DNS协议信息

它查询和回复都有一样的格式。![image-20220605072650031](C:\Users\Tung\AppData\Roaming\Typora\typora-user-images\image-20220605072650031.png)

#### DNS 安全

- DDoS Attacks: 轰炸根服务器，轰炸TLD服务器
- Redirect Attacks重定向攻击:中间人拦截，DNS中毒
- Exploit DNS for DDoS:发送虚假原地址

---

### Peer to Peer(P2P): Skype 

没有永远在线的服务器；任意终端直接连接；向同类之间发请求互助，主机之间通过对等方式进行交互通信（自我拓展性）；同类间歇性连接，会更换IP地址

#### [计算题]文件分发的时间

##### Client-Server

服务器传输需要顺序发送N个文件，发一份的时间:F/$u_{s}$, 发N份则需要*N

客户端需要下载文件，$d_{min}$为最小客户端下载速率，最短要F/$d_{min}$

所以说，以此途径分配F个文件给N个客户端的时间 
$$
D_{c-s}>=max\{NF/u_s, F/d_{min}\}
$$


##### P2P

服务器传输需要上载至少一个副本: 发一个花 F/$u_s$

每个客户端都需要下载副本，最小花F/$d_{min}$

所有客户端作为聚合必须下载NFbits，最大上传速率为$u_s$ + $∑{u_i}$

因此，以此途径分配F个文件到N个客户端的时间 
$$
D_{P2P}>=max\{{F/u_s, F/d_{min},  NF/(u_s+∑u_i)\}}
$$
N越大， P2P的优势（耗时最小）就更明显。

- [ ] Bit Torrent 啊俺没看呢

---

### Video streaming and content distribution networks(CDN)

**流式直播流量 Stream Video Traffic：**互联网带宽的主要消费者。规模很大，异质性（不同用户不同能力，区别于带宽、有线vs移动），要靠分布式的应用级设施解决以上两个问题。

#### 多媒体：视频Video

视频是一序列的图像以恒定速度显示，数字图像是像素点阵列，每个像素以比特表示编码，使用图像内部和图像之间的冗余减少用于解码的位数

CBR（恒定比特率）：视频编码速率固定；VBR（可变比特率）：会随着时空变化

**流式储存视频主要挑战**：服务器到客户端的带宽会随着网络拥塞等级变化而变化；拥塞导致的数据包丢失和延迟会延迟播放，或导致视频质量差。

#### 流式多媒体：DASH

Dynamic, Adaptive Streaming over HTTP 基于HTTP的动态自适应流

**服务器**：把视频文件分为多块，以不同速率存储和编码

**客户端**：定期测量C-S的带宽，自诩清单，一起请求一块。在给定带宽情况下选择可持续的最大编码速率，可在不同时间点选择不同的编码率

#### CDN 内容分发网络

在CDN节点存储内容副本，订阅者从CDN请求内容（定向到附近的副本）



### 套接字 Socket programming

进程收发信息都要通过其套接字（Sockets)，类似于快递员。可以看成在两个程序进行通讯连接中的一个端点，一个程序将一段信息写入Socket中，该Socket将这段信息发送给另外一个Socket中，使这段信息能传送到其他程序中。

发送者进程把信息给到sockets; 发送者进程依赖于另一边门上的混熟基础设置来传递给接收方进程的sockets；涉及两个sockets:每侧一个

传输服务的两种socket类型：UDP：不可靠的数据报；TCP：可靠，面向字节流

#### Socket programming with UDP

客户端服务端之间没有连接，发信息不握手，发送方明确的把IP目的地址和端口附在包中，接收方从接收的数据包里提取发送者ip和端口号。

传输的数据可能会丢失或者顺序错误。（代码见week5-2-57）

#### Socket programming with TCP

客户端必须和服务端联系，得先跑服务端创建sockets来接客户端的联系。客户端可以通过创建TCP sockets，指定服务端进程IP地址和接口来联系服务端，客户端创建sockets时建立与服务器TCP的连接。被TCP联系后，服务端TCP就会创建新的socket来和特定客户端交流。

---

## L3 Transport Layer 传输层

在底三层（物理、链路、网络）的基础上构建，使用底层功能提供服务。为在不同主机上运行的进程提供应用程序之间的逻辑通信。我们要理解多路复用，可靠传输，流控制，拥塞控制

**主要两个传输协议：TCP, UDP**

### Transport-layer services and principles 

传输层服务：提供应用程序**进程之间**的逻辑交流，在终端系统运输协议行动（网络层提供的是主机之间的逻辑交流）

*发送方：*将消息分段，传递到网络层（IP）；

*接收方：*从IP获取数据段，检查header值，将数据重组成消息，传递到应用层

| TCP(Transmission Control Protocol)               | UDP（User Datagram Protocol) |
| ------------------------------------------------ | ---------------------------- |
| 可靠，有序传输Reliable, in order                 | 不可靠，不有序               |
| 拥塞控制，流控制Congestion control, flow control | 尽力而为的简单拓展           |
| 连接设置 Connection setup                        |                              |

### multiplexing and demultiplexing applications 

de-multiplexing分成多路复用： transport -> O O O in application（分头行动）

multiplexing多路复用: O O O in application -> transport（汇聚在一起）

multiplexing at sender：处理来自多个sockets的数据，给他们加传输header

demultiplexing at reseiver:用header信息交付收到的信息来更正sockets，使用ip地址和端口号将片段定向到合适的套接字。UDP：指定好dest host port；TCP：获取四元组来定向

`四元组`：Dst port, Dst ip address, Src port, Src ip address

### Connectionless transport: UDP 用户数据报协议

不握手不可靠，每一个UDP段都独立。

UDP不依赖于网络，更为简单，没有拥塞控制，小header。

UDP 使用在流多媒体应用，DNS，SNMP,HTTP/3，如果需要UDP可靠传输，可以在应用层增加需要的可靠性或者拥塞控制。

UDP发送方：将消息分段，决定header,创建段并发送到IP

UDP接收方：收到IP来的段，**检查UDP检验和**header value, 提取应用层消息，解复用消息

##### UDP Checksum检验和

目的是用来检测传输错误，验证报文在网络传输过程中的完整性。有些数值可能在传输的过程中变了（0-1翻转）导致报文出错，这样他们sender和receiver算出的值就会有偏差。因此发送端会根据报文算出校验和，让接收端做检验。接收端若认为出错，就会丢掉其报文。



发送者：处理UDP内容作为16位整数序列的段，校验和是这些段的和（溢出需要回卷）做一次反码运算（0-1翻转），放在校验和字段。

接收方：计算。一般是把所有的值（二进制位每16位都加一次）再加上校验和字段看是否为全1（或者字段和与校验和相同）

Week protection:有时候即使数字真变了，checksum可能没变化

---

### Principles of reliable of data transfer 可靠数据传输RDT

我们需要可靠性，网络层提供的服务没有保证数据丢失、包顺序和翻转比特位。

可靠数据传输协议的复杂度会决定于不可靠信道的特性。

开始需要逐步开发RDT协议的发送和接受放，考虑单项数据传输，用有限状态机来指定两方。

`RDT1.0`:基础管道很可靠，无错位和丢失。接收方和发送方有独立的FSM

`RDT2.0`：有比特错误，可能会翻转。这样就需要弥补错误。

***ACK***（Acknowledgements）：接收方明确告诉对方自己收到了

***NAK***（negatibe acknowledgement):告诉对方有错误！！麻烦重发pkt

这样的话，发送方发了一个包就需要等待回应。但如果ACK/NAK出问题了怎么办，发送方就会不知道接收方的状态了，不能只重发（可能会重复）。

`RDT2.1`：处理乱码ACK/NAK，**处理重复：**如果ACK/NAK损坏，发送方重发当前数据包。发送者会给发出去的包加上序列号，接收者就需要丢弃重复的包。接收者必须检查包是否重复，接收者不能知道最后一个ACK/NAK能不能被发送者收到

`RDT2.2`:一种无NAK协议。和上一个功能一样，但不需要发NAK，只发ACK。收到者发送最后一个包的ACK，必须明确包括它的序列号。重复的ACK代表了NAK，得重传。

TCP就是用这个方法来无NAK的。

`RDT3.0`:有误差和损失的渠道。发送方会等合理时间，如果等不到ACK就重发。如果只是因为时间太久发重复了可以靠seq解决。用倒计时定时器来做时间中断。流水线协议操作，允许多个进行中、未确认的包。这样需要算U的时候乘上N。

D=L/R， U=D/(RTT+D)=(L/R)/(RTT+L/R)

- [ ] **Go-back-N 回退N步**: comulative ACK（累计ACK）什么东西搞不懂

**Selective Repeat选择重传：**接收器单独确认所有正确收到的包，发方超时单独重传每个没ACK的包。

发送方数据来自上方，timeOut(n)：重发包n，重启timeer;ACK(n):标记已接收！n如果是最小的未确认包，将窗口向前移动。

接收方：数据包n：发送ACK

---

### Connection-oriented transport: TCP 传输控制协议

#### 浅了解一下⑧

- Point-to-point点对点:一发一收
- 可靠，有序字节流：不会有信息界限
- full duplex(全双工)data：同个连接里双向数据流，最大分段尺寸
- 累计ACK (cumulative ACK)
- 流量受控：发送方不会overwhelm接收方
- pipelining流水线管道：TCP拥塞和流量控制设置窗口大小
- **面向连接的**：交换信息之前握手交换控制信息来初始化收发两者状态

![image-20220606055606944](C:\Users\Tung\AppData\Roaming\Typora\typora-user-images\image-20220606055606944.png)

```Sequence Numbers:```字段中第一个字节的字节流数量

```Acknowledgements```:下一个字节的序列号，累计的

```MSS最大字段尺寸```：通常设置为本地主机可发送的最大链路层帧长度，即最大传输单元MTU

##### TCP往返时间（round trip time）,timeout

timeout要比RTT长，太短容易过早超时导致没必要的重传；太长会没反应过来丢了字段

如何评估RTT? SampleRTT可以测量从字段传输到ACK接受的时间。越靠近越平滑

EstimatedRTT = (1- α)* EstimatedRTT + α *SampleRTT

##### TCP发送方所做的

1. 遇到了从应用接收的数据，则创造有序列号的字段，启用没启用的计时器，
2. 遇到了超时：重传！重启定时器
3. 遇到了ACK接收：如果这个ACK以前没确认过，就更新一下已知ACK，还有没确认过的ACK则启动计时器。

##### TCP 接收方所做的

1. 遇到了期望序列号的有序段，之前的数据都ok: 稍微延迟一点确认，等500ms都没有下一段的话就发送ACK
2. 遇到了期望序列号的有序段，但之前还有一个ACK待定：立刻发掉受伤在等的ACK，确认这两个有序数据字段。
3. 收到了乱序字段（序列号比期望的还高）：立刻发多余重复的ACK指定出问题的seq

#### TCP Flow Control流量控制

如果网络层传输数据的速度比应用层删sockets缓存区的数据速度还快咋办？

流量控制就是接收者会控制发送方来使对方不会传输太多太快而溢出接收方的缓冲区。

TCP接收方会在报头的`rwnd`字段中通告出空闲缓存空间，RcvBuffer 大小一般4096字节。发送方根据接收到的`rwnd`将还没确认的那些数据进行数量限制来保证缓冲区不会溢出。

#### TCP Connection Management连接管理

终于要讲到我们的三握四挥了，激动!!

交换数据之前，双方握手同意建立联系，就连接参数达成一致。

##### 建立连接：三次握手🐨

最初两者都是关闭状态。 Server首先创建TCB准备接受连接请求，处于监听状态，等待客户端的连接请求。接下来我们让Client主动打开连接，

1. Cllient发出连接请求，SYN=1,seq=x,不携带数据。TCP变为SYN-SENT状态。
2. Server收到连接请求，同意则向Client发送确认。SYN=1,ACK=1,seq=y,不携带数据。Server进入SYN-RCVD状态
3. Cilient收到确认。向Server给回自己的“确认确认”。确认报文段ACK=1,seq=x+1，（此时携带数据才会消耗序号）。此时，TCP连接建立，Client进入ESTABLISHED状。

##### 两次握手（X）

这是达咩的。比如客户端发了一个请求没有丢失而是只是滞留延误了，服务端却没有做好接受准备，那么之后失效的连接请求如果又发给了服务端，就会出错。如果不进行第三次握手，使得Server发出确认就以为建立好了连接，会导致它空等很久，浪费资源。

##### 四次握手（妹必要）

本身通信协议就做不到完全可靠，三次握手已经可以让客户端和服务端确认当前通信状态，再增加握手次数也不能做到保证后面的通信完全可靠，所以没有必要。

##### 关闭连接：四次挥手😁

由于TCP的连接是全双工的，所以每个方向都需要单独进行关闭。这个原则是当一方完成它的数据发送任务后就能发送一个FIN包来终止这个方向的连接。收到一个FIN包代表不会再有此方向的数据流动，但还是可以发另一个方向的数据的。

1. Client发出FIN包，FIN=1,关闭C-S的数据传输，进入FIN_WAIT_1状态
2. Server收到FIN，发送一个ACK，表示确认C-S方向的全关，进入CLOSE_WAIT状态
3. Server发出FIN包，FIN=1，ACK=1,关闭S-C的数据传输，进入LAST_ACK状态
4. Client收到FIN，进入TIME_WAIT状态，发回一个ACK包给Server确认。Server收到后进入CLOSED状态。此时TCP连接关闭。

---

#### principles of Congestion control 

**Congestion 拥塞**：太多的资源以太快太大量的形式传来让网络顶不住，供不应求，性能会变拉

表现形式：很长的延迟（queueing in router buffer）;丢包（buffer overflow at routers）

**Congestion control 拥塞控制**：防止数据过多的注入到网络的做法。

- [ ] 场景： 家人 有点没看懂捏

拥塞控制算法：1.慢启动	2.拥塞避免	3.快重传	4.快速恢复

1. 端到端拥塞控制：没哟来自网络的明确反馈，拥塞判断来自观察到的delay,loss，tcp这样
2. 网络辅助拥塞控制：路由器提供直接反馈给收发方，可能指出拥塞程度或者显式地发送速率

### TCP Congestion control

AIMD：发送方可以增加发送速率，直到发生拥塞，然后在发生丢失时降低发送速率

分布式异步算法，*AIMD=Additive Increase, Multiplicative Decrease* 

<img src="C:\Users\Tung\AppData\Roaming\Typora\typora-user-images\image-20220606070128112.png" alt="image-20220606070128112" style="zoom:33%;" />

TCP还会发送`cwnd`字节,等待ack的RTT再发更多，TCP rate=cwnd/RTT,

cwnd是观察网络拥塞状态动态调整的

##### TCP Slow Start慢启动

连接开始时指数增长速度直到第一次loss， 初始化cwnd=1 MSS, 每RTT时间双倍一下cwnd, 通过收到每个ACK时递增cwnd完成。总之初始速率较为缓慢，上升指数超快

- [ ] TCP CUBIC不太懂

---

## L4 Network Layer: Data Plane 网络层数据平面

### Network Layer:overview

网络层提供的服务：从发送方向接收方传输字段。

每个互联网设备中的网络层协议：host, routers

**Routers 路由器**：检查所有通过它的IP数据报中的报头字段，将数据从输入端口沿着路径移动到输出端口。

所以说，网络层就是这两个重要功能。

1. **Forwarding转发**：将到达的数据包从路由器的输入链路移动到适当的路由器输出链路
2. **Routing路由**：全局操作，确定数据包采用的原目标路径路由算法

#### Data Plane数据平面

forwarding, 局部的，每一个路由器的功能。

决定到达路由器的输入端口的数据报如何被转发到路由器输出端口，将数据包从路由器的输入放到合适的输出。

#### Control Plane 控制平面

routing, 全网络逻辑，确定数据报如何沿着源主机到目的主机的延伸路线被路由

两个方法：1.传统路由算法，在路由器中实现 	；2.软件定义网络（SDN）服务器中实现

#### 网络层服务模型：Best Effort

在互联网中，网络层向上只提供简单灵活的，无连接的，**尽最大努力交付**的数据报服务。即网络层不提供服务质量的承诺，不保证成功交付，不保证时间和顺序，不保证可用带宽。

机制简单使得互联网被广泛应用；充足的带宽使得实时应用的性能大部分时候都很不错；复制的应用层分布式服务连接接近客户的网络，允许从多个位置提供服务；弹性的拥塞控制

---

### What's inside a router

路由器里面到底有什么~㊙

![image-20220606075947646](C:\Users\Tung\AppData\Roaming\Typora\typora-user-images\image-20220606075947646.png)

#### Input port function输入端功能:

- Decentralized Switching分散交换：使用header字段值和输入端内存中的转发表来查找输出端口
- 目标是以生产线速度完成处理输入端口
- Input port queuing输入端口排队：如果数据包的到达速度比转发速度还要快,可能会延迟或丢包。（）
- Destination-based forwarding基于目标的转发: 仅基于目标IP做转发
- Generalized forwarding广义转发：基于任何一组header进行转发

**Longest prefix matching 最长前缀匹配:** 当查找给定的转发表条目时目的地址，使用最长的地址前缀匹配目标地址。通常使用三重内容可寻址存储器（TCAM），在一个时钟周期内检索地址。

**Head-of-the-Lone Blocking(HOL阻塞)**:排在队列前面的数据报阻止其他人向前移动

#### Switching fabrics交换结构

从输入链路把包传输到合适的输出链路。主要分三种：memory,buss,interconnection

![image-20220606082336859](C:\Users\Tung\AppData\Roaming\Typora\typora-user-images\image-20220606082336859.png)

**Switching Rate交换速率**:数据包从输入到输出可以被传输的速率。通常以输入/输出线路速率的倍数来衡量，N个输入时速率为线路速率的N倍

1. Memory内存:切换由CPU直接控制的传统计算机。数据包会复制到系统内存中，速度受内存带宽限制
2. Bus: 通过共享总线。交换速度受总线带宽限制。
3. Interconnection network: 交叉开关，Clos网络，最初开发用于处理多处理器。多级交换机：nxn。平行利用。

##### Buffer Management

- drop: buffer满了且有新的包要加进来就丢包。可以看优先度或者丢尾巴的
- marking:将有的包标记为拥挤

#### 包调度Scheduling：

用来决定哪一个包下一个来。抽象：队列

- First come first served (FCFS/FIFO): 根据到达输出口的顺序来
- priority：按类排队，从具有缓冲包的高优先级的队列发送包
- round robin (RR)：按类排队，服务器循环的重复的扫描类别队列，依次从每个可用的类别发送一个完整的包
- weighted fair queueing(WFQ)：每个类都有权重，保证最小带宽

#### Network Neutrality网络中立

技术层面，一个ISP如何分享分配它的资源

---

### IP: Internet Protocol 互联网协议

**IP Protocol**: 1. IP Datagram format 2.addressing 3.packet handling conventions

![image-20220606232528147](C:\Users\Tung\AppData\Roaming\Typora\typora-user-images\image-20220606232528147.png)

#### IP Address IP地址: 

IP地址：32位标识符，与每一个主机或路由器接口相关联；接口：主机.路由器与物理链路的连接。路由器一般有多个接口，主机一般有一两个接口。

IP地址有两个结构：子网部分：有共同高比特位的设备；主机部分：剩余的低位。这个分界线看后面跟着的数字x来指定位数。

**Classless InterDomain Routing(CIDR)无类域间路由**：子网长度任意，格式a.b.c.d/x

#### Subnet子网

不需要通过中间路由器就可以相互物理连通的设备接口。

子网将每个接口从其主机或路由器形成独立网络的孤岛。每个孤立的网络称为子网。

可见[L1中的例子](#子网 Subnet in L1)

主机获得IP地址的方式分两个，1.在sysadmin配置文件硬编码 2.DHCP

#### Dynamic Host Configuration Protocol(DHCP)动态主机配置协议

目标：当主机加入网络时，它会动态的从网络服务器获取IP地址。可以重置在用的地址，在主机地址连接或打开时可以重复使用地址，支持移动用户的加入和离开网络

流程：Host广播DHCP discover信息问是否有服务器，DHCP服务器以DHCP offer消息响应告诉对方有可用IP，host请求IP地址(DHCP request)，DHCP服务器给地址(DHCP ack).

通常DHCP服务器将位于路由器中，为路由器所连接的所有子网提供服务。DHCP返回的可以不仅仅是子网中分配的IP地址，还有客户端第一跳路由器地址，DNS服务器的名称和IP网络掩码。

#### Hierarchical Addressing 分级寻址

网络怎么得知IP地址的子网部分呢？A：获取供应商ISP地址空间的已分配部分

分级寻址允许高效的广告路由信息，更具体的路线。

ISP怎么获得地址块？ **ICANN互联网名称与数字地址分配机构**通过5个区域注册管理机构（RRs)分配地址，管理DNS跟区域，包括个人TLD的授权管理。

ICANN在2011就已经分配完了地址，NAT有助于IPv4地址空间好近，IPv6有128位地址空间

#### NAT: network address translation (网络地址转换)

就外界而言本地网络所有设备在共享同一个IPv4地址。

所有离开本地网络得数据报都有相同得源NAT IP地址，但源端口号不同。本地网络中的所有设备在只能在本地网络中使用的“私有”IP地址空间(10/8、172.16/12、192.168/16前缀)中都有32位地址。

**好处：**

- 所有设备只需从提供商ISP处获得一个IP地址
- 可以在不通知外界的情况下更改本地网络中主机的地址
- 可以在不改变本地网络中设备地址的情况下更改ISP 
- **安全性**:局域网内的设备不可直接寻址，对外界可见

实现NAT路由器必须要替换传出数据报：将每个源IP地址和端口换为NAT的IP地址和端口；在NAT转换表中记住每一个转换对；用存在NAT表中的相应的替换对来替换四元。

NAT一直备受争议，因为路由器应该只处理第三层，地址短缺应该被IPv6解决，违反了端到端参数，NAT穿越。

#### IPv6

当32位IPv4地址空间将被完全分配时咱IPv6的作用就出来了，这是初始动机。

**额外动机**: 1. 速度处理/转发:40字节固定长度报头	2.支持“流”的不同网络层处理

![image-20220607015156408](C:\Users\Tung\AppData\Roaming\Typora\typora-user-images\image-20220607015156408.png)

比起IPv4没有检验和（可以给路由器的进程加速），没有碎片/重组，没有options

不是所有的路由器都可以同时升级，从IPv4到IPv6的。

**Tunneling隧道**：IPv6数据报在IPv4路由器间的IPv4数据报中作为有效负载

---

### Generalized Forwarding通用转发, SDN

首先路由器是包括一个转发表的，`match plus action`“匹配加动作”抽象：匹配到达包中的位，然后采取行动。1.基于目标的转发		2.通用转发：很多可能性，很多标题字段可决定

#### 转发表抽象

**Flow 流**: 由（链路层、网络层、传输层中的）报头字段值定义

**通用转发**：简单的数据报处理规则。

- Match 匹配：报头中的模式值
- Actions 操作：对于匹配包的丢弃转发修改或者发到控制器
- Priority优先值：消除重叠模式
- Counters计数器：字节数和数据包数

##### OpenFlow： 

**匹配+动作**：这个抽象同意了不同种类的设备。

| 设备            | 匹配Match             | 操作Action     |
| --------------- | --------------------- | -------------- |
| Router路由器    | 最长目标IP前缀        | 转发出链路     |
| Switch交换机    | 目标物理地址          | 转发或泛滥（？ |
| Firewall防火墙  | IP地址和TCP/UDP端口数 | 允许或拒绝     |
| NAT网络地址转换 | IP地址和端口          | 重写地址和端口 |

![image-20220607023849073](C:\Users\Tung\AppData\Roaming\Typora\typora-user-images\image-20220607023849073.png)



## L5 Network Layer: Control Plane 网络层控制平面

### Control Plane 控制平面

routing, 全网络逻辑，确定数据报**如何**沿着源主机到目的主机的延伸路线**被路由**

两个方法：1.传统路由算法，在路由器中实现 	；2.软件定义网络（SDN）服务器中实现

##### 构建网络控制平面的两种方法:

1. 每路由器控制(传统)
2. 逻辑集中控制(软件定义的网络)

#### Per-router control plane每路由器控制

每台路由器中都包含转发和路由器选择功能

#### Logically centralized contro逻辑集中控制

- 逻辑集中式控制计算并分发转发表以供每台路由器使用。
- 控制器与每台路由器中的一个控制代理（CA）进行交互。
- CA不能直接相互交互也不能主动参与计算转发表，这是每路由器控制和逻辑集中式控制之间的关键差异。

### Routing Protocol路由协议

目标：通过路由器网络确定从发送主机到接收主机的好路径，相当于路由

**Path 路径**：路由器数据包从给定的初始源主机传输到最终主机的顺序

好路径的定义：很少的cost, 更快，更少的拥堵least congested

**Graph abstraction图形抽象: link costs链接成本**

cost由网络运营商定义，可以常为1，或与带宽成反比，与拥塞成反比。

G=（N,E)，N=set of routers, E=set of linnks

#### **路由算法分类：**

1. **global全局:**所有路由器都已完成拓扑，链路开销信息; “链接状态”算法
2. **decentralized集中:**计算的迭代过程，与邻居交换信息路由器最初只知道到相连邻居的链路开销 ;“距离矢量”算法
3. **dynamic动态：**:路线变化更快，定期更新或响应链路成本变化
4. **static静态：**路线会随着时间慢慢改变

#### Link state链接状态算法

##### Dijkstra's link-state routing algorithm

迪杰斯特拉算法，集中式的：网络拓扑，所有节点都知道链路开销。通过链接状态广播可以完成，所有节点都有相同的信息。计算从一个源节点出发到其他所有节点的最少cost路径,把转发表给那个节点。算法是迭代的，k次迭代之后就可以知道去k个目的地的最小成本路径了。

![image-20220607064902496](C:\Users\Tung\AppData\Roaming\Typora\typora-user-images\image-20220607064902496.png)

算法的复杂度：N节点的话，$O(n^2)$复杂度，高效一点：$O(nlogn)$

消息的复杂度：每台路由器都得向其它的节点信息广播其链路状态信息。高效的广播：O(n)交叉传播来自一个源的广播消息。每个路由器都这样，那么总的就是$O(n^2)$

#### Distance vector距离矢量算法

基于贝尔曼-福特(BF)方程动态规划：这个值是x到y的最小成本路径成本：
$$
D_x (y) = min_v \{ c_{x,v} + D_v (y) \}
$$
每个节点不时向邻居发送自己的距离矢量估计值。发了新的估计值可以更新DV。在较小的自然条件下，估计值Dx (y)收敛到实际最小成本dx (y)。

每个节点就要循环：等待，重算DV值，如果改变了DV值得通知别人。

**迭代、异步**：局部迭代会被这俩原因引起：1.本地链路成本变化	2.来自邻居的更新通知

**分布式、自停止**：每个节点仅在其DV改变时通知邻居然后邻居通知他们的邻居。仅在必要时候通知，没收到信息就不采取行动！

#### LS vs DS 算法

##### Message complexity消息复杂度

- LS: n个路由器，$O(n^2)$
- DV:邻居之间交换，收敛时间不一定

##### Speed of convergence收敛速度

- LS: $O(n^2)$算法和消息复杂度，可能会振荡
- DV：收敛时间不一样，可能会有路由循环，计数到无穷大问题

##### Rubustness 鲁棒性

- LS: 路由器可能会公布不正确的链路，每个路由器都各自算自己的表
- DV: DV路由器可以通告不正确的path cost: black-hole, 每个路由表都被其他人用，错误通过网络传播。

### Intra-ISP routing: OSPF

 使用 链路状态LS 算法 ; 用于 大型网络。公开提供的，经典的LS算法，

**Scale规模**： 数十亿的目的地无法存完在路由表上，这个路由表交换会压垮链路。

**Administrative autonomy行政自主权**：互联网是网络们的网络、每个网络管理员可能都想要控制自己网络中的路由。

将路由器聚合到“自治系统Autonomous System”的区域中。

**最终目的 : 所有的路由器 都有一个 链路状态数据库 ( 全网拓扑图 )** 

**inter-AS**: 在AS之间路由。网关执行域间路由。政策：管理员想控制流量，性能可被关注。

**intra-AS**: 在相同的AS内路由。AS中所有路由器必须运行相同的域内协议。不同的AS中的路由器可以运行不同的域内路由协议。网关路由器：在自身as的边缘具有到其它AS路由器的链路；政策：单一管理员。政策主导性能

- **RIP: Routing Information Protocol** 使用DV算法，小型网络。经典DV每30秒交换一次DV，不再广泛使用
- **EIGRP: Enhanced Interrior Gateway Routing Protocol** 基于DV，Cisco专利
- **OSPF: Open Shortest Path First** 基于LS路由，IS-IS协议

### Routing among ISPs: BGP

**Border Gateway Protocol(BGP)** 外部网关协议

1.互联网的规模太大，使得自治系统AS之间路由选择非常困难。
2.自治系统AS之间的路由选择必须考虑有关策略。

所以不同自治系统AS之间的路由不使用内部网关协议，BGP并非要找出一条最佳路径，只是要求找出一条能够到达目的网络且比较好的路由。是运行在AS之间的一种协议,寻找一条好路由：首次交换全部信息，以后只交换变化的部分,BGP封装进TCP报文段

BGP允许子网向互联网的其他部分通告其存在以及可以到达的目的地。

BGP给每个AS提供一个方法： 

1. **eBGP**: 从相邻的AS获得子网可达性信息(也就是别的自治系统获取)

2. **iBGP**:向同一个AS内部所有路由器传播可达性。

   根据这个可达性Reachability Information和策略来确定通往其他网络的好路由。

一个 BGP 发言人与其他自治系统中的 BGP 发言人要交换路由信息，就要先建立 TCP 连接，然后在此连接上交换 BGP 报文以建立 BGP 会话(session)，利用 BGP 会话交换路由信息。
使用 TCP 连接能提供可靠的服务，也简化了路由选择协议。
使用 TCP 连接交换路由信息的两个 BGP 发言人，彼此成为对方的邻站(neighbor)或对等站(peer) 。

共使用四种报文 

- OPEN,打开报文，和相邻的建立关系
- UPDATE,更新报文，用来发送某一路由人多信息和列出要撤销的路由
- KEEPALIVE，确认打开报文和周期性地证实邻站关系
- NOTIFICATION，通知，发送检测到的差错。

路由器可能会了解到多条通往目的地AS的路由，并根据以下条件选择路由:

1. 本地偏好值属性:策略决策 
2. 最短路径 
3. 最近的下一跳路由器:烫手山芋路由 （hot potato哈哈哈哈
4. 附加标准

- [ ] 家人，BGP我懒得看啊！

### SDN control plane软件定义网络控制平面

Software defined networking(SDN),现在的网络是TCP/IP的天下，但网络不是完美的，存在各种问题。1.协议体系修修补补会显得臃肿 2.网络是封闭被动的，业务被动承载，很难根据业务升级 3.云计算兴起... 所以需要一种全新的架构。

SDN是一个网络设计理念，只要是网络硬件可以集中式软件管理，可编程化，控制转发分开，并且有开放的接口，就可以认为是一个SDN网络。

为什么是逻辑上集中的控制平面呢？

- 更简单的网络管理：避免路由器错误配置，更大的流量灵活性
- 基于表转发允许变成路由器。集中编程更方便，分布的会比较难
- 开放实施

#### Data-Plane switches

在硬件中实现广义数据平面硬件转发的快、简单、商用交换机。

在管理员监督下安装和计算流转发表。

基于表格的开关控制的API定义什么可控不可控。和控制器可交流的协议。

#### SDN controller(network OS)

![image-20220607085555622](C:\Users\Tung\AppData\Roaming\Typora\typora-user-images\image-20220607085555622.png)

维护网络状态信息

通过北向API与“上方”网络控制应用程序交互

通过南行API与“下方”网络交换机交互

作为分布式系统实施，以提高性能、可扩展性、容错性和健壮性.

#### network-control apps

控制的“大脑”: 使用由SDN控制器提供的低层服务和API实现控制功能

未捆绑:可由第三方提供:不同于路由供应商或SDN控制器

#### Openflow

**controller-to-switch messages**

feature, configure, mofify-state, packet-out, packet-in, flow-removed, part-status

### Internet Control Message Protocol （ICMP)

**互联网控制信息协议**，被主机和路由器用来交流网络级别的信息。像错误报告、回应request/reply。高于IP的网络层：IP数据报中封装ICMP消息。ICMP消息是类型、代码加上导致错误的IP数据报的前8个字节。

#### 应用：

- Ping应用：网络故障的排查；
- Traceroute应用：可以探测IP数据报在网络中走过的路径。

### Network Management

**Autonomous System(自治系统 又叫Network网络)**：数以千计的交互硬软件组成

其他复杂的系统也需要监控和配置和控制，网络管理包括硬件、软件和人工元素的部署、集成和协调。

网络管理组件：

1. Managing Server管理服务器:应用程序，通常由网络管理员(人)参与
2. Managed Device管理设备: 具有可管理、可配置的硬件、软件组件的设备
3. Data数据: 设备“状态”配置数据、操作数据、设备统计数据
4. Network management protocol网络管理协议:由管理服务器用来查询、配置、管理设备；由设备用来通知管理服务器数据、事件。



## L6 The Link Layer and LANs 链路层

物理寻址，同时将原始比特流转变为逻辑传输线路。数据链路层的协议定义了通过通信媒介互连的设备之间传输的规范。为网络层提供可靠的数据传输，基本的数据单位是帧Frame，主要协议：以太网协议

重要的设备名称：网桥、交换机Switch。

#### Introduction

链路层负责通过链路将数据报从上一个节点（Node, 主机或者路由器）传输到物理上想层的节点。不同的链路协议通过不同的链路传输数据报，比如wifi在第一个link, 以太网在下一个link。每一个链路协议提供不同的服务例如可能会也可能不会提供可靠的链路传输。

![image-20220608052747584](C:\Users\Tung\AppData\Roaming\Typora\typora-user-images\image-20220608052747584.png)

#### 链路层服务：

1. **Framing, link access成帧、链路访问**：将数据报封装到帧中，添加报头报尾；如果是共享媒体则进行频道访问；帧头中的MAC地址能够标识出源、目的。
2. **Reliable delivery between adjacent nodes相邻节点之间的可靠传输**
3. **Flow control控制流**：相邻发送和接收节点之间的步调
4. **Error detection错误检测**：信号衰减、噪声引起的误差。接收器检测到错误，发出重新传输信号，或丢弃帧
5. **Error correction纠错**：接收器识别并纠正误码，无需重新传输
6. **half-duplex and full-duplex半双工和全双工**

链路层在每一个主机都有事先，在网络接口卡NIC中实现，连接到主机的系统总线，是硬件软件固件的组合。

### Error detection 错误检验

EDC：错误检测和纠错的比特位，D：受错误检查保护的数据，可能包含标题字段

#### Parity checking奇偶校验

1. 单比特奇偶校验： 检验单位的错误。偶数奇偶校验位1为偶数个1
2. 二维比特奇偶校验：监测并纠正单位错误

#### Internet checksum网络检验和

检测传输数据段中的错误(即翻转的位)

**Sender**: 

- 将UDP数据报和内容（包括其报头和地址）视为16位整数序列；
- 校验和：数据段内容的相加
- 将校验和值放入UDP的校验和字段

##### Receiver

- 计算接收数据段的校验和
- 检查计算的校验和是否等于校验和字段值: 校验和不等则有错；等于的话，也可能有啦

#### Cyclic Redundancy Check (CRC)循环冗余码

更强大的错误检测编码!!!循环冗余校验码，是数据通信领域中比较常见的一种查错校验码，它的特征便是信息字段和校验字段的长度可以任意选定。

D:data bits数据位(给定时，将这些视为二进制数) 

G: bit pattern位模式(generator发生器)，r+1位(给定)

若用D* 2^r 除以G 刚好余R,则成功。

教科书P292 有一个CRC例子。传输的是101110011， D=101110，d=6,G=1001,r=3

### multiple access protocol多路访问协议

确定节点如何分享信道的分布式算法，节点通过这个协议来规范他们在共享广播信道上的传输行为。这个沟通必须使用信道本身。多个同时传输的帧可能碰撞collide

两种网络链路：

**Point-to-point点对点**

由链路的一端单个发送方和链路另一端的单个接收方组成。

**Broadcast广播**

可以让多个发送和接受节点都连接到相同、单一、共享的广播信道上。

目前分三个类型的多路访问协议 MAC protocol

1. **Channel partitioning protocol信道划分协议**：信道被分为更小的块，分配这些块给节点专用
2. **Random access protocol随机接入协议**：信道没被分开，允许碰撞，还可以自己恢复
3. **taking turns轮流协议**节点排队轮流，但是会更久更大量

接下来是几个信道划分物理地址协议。

#### Time Division Multiple Access (TDMA)

**时分多路复用访问**。将时间划分为时间帧，并进一步分为时隙Slot。在某个节点需要发送分组（链路层交换的数据单元）时，他会在循环的TDM帧中指派给他的时隙内传入分组比特。

轮次进入渠道，每个站点都有固定长度的时隙(slot)。消除了碰撞，非常公平。

缺点：速度限制，节点总是在等待伦次。

#### Frequence  Division Multiple Access (FDMA)

**频分多路复用。**把信道分为不同频段，并把每个频率分给N个节点中的一个。在较大的R bps信道中创建了N个较小的R/N bps信道。

#### Code Division Multiple Access (CDMA)

**码分多址。**为每一个节点分配不同的编码，每个节点用它唯一的编码来对它发送的数据进行编码。如果精心选择这些编码，就可以做到不同的节点可以同时传输。各自的相应接收方都可以正确接收数据比特，不在乎其他节点的干扰。（抗干扰性）目前广泛民用和军用。



#### 随机接入协议 RA

节点以全部速率传输，有碰撞时涉及的节点反复重发直到无碰撞地通过。

以下是两种随机接入协议。

#### ALOHA协议

##### Aloha

非时隙，完全分散。帧首次到达，节点就把他完整的传输入广播信道。若经历了碰撞，立刻以p概率重传，否则等待一个帧的传输时间后以p概率重传。

##### 时隙S-Aloha

所有的帧同大小L，时间被划分为相同的时隙L/R，节点在时隙起点传输帧，同步节点，要是有2个及以上的节点传输，所有节点都会检测到碰撞。

操作比较简单，节点有帧要发则等下一个时隙开始后传输整个帧，没有碰撞则成功；有碰撞则在时帧结束前检测到碰撞，以概率p在后续的每个时隙重传此帧。

高度分散，允许有唯一活跃节点时全速连续传输。有N个活跃节点时效率是$Np(1-p)^{N-1}$.



#### Carrier sense multiple access(CSMA) 载波侦听多路访问协议

**简单的CSMA**传输前先监听，然后信道空闲则传输整个帧，忙则延迟。802.11

**CSMA/CD**：带有碰撞侦测的CSMA， 短时间内检测碰撞，冲突传输终止，减少信道浪费；有线的检测会比无线检测简单。以太网用它

效率定义为，有大量活跃节点且每个节点有大量帧要发送的话帧在信道中无碰撞地传输那部分时间在长期运行时间中所占的份额。

![image-20220608072218113](C:\Users\Tung\AppData\Roaming\Typora\typora-user-images\image-20220608072218113.png)

#### 轮流协议

##### Polling 轮询

要求节点之一为主节点，主节点以循环的方式轮询每个节点。告诉他们能够传输的帧的最大数量。主节点去观察信道上是否缺乏信号。

缺点：轮询开销，延迟，主节点要是有问题就会整个信道不可操作

Bluetooth蓝牙使用的就是轮询。

##### Token passing令牌传递

一个称为令牌的小的特殊帧在节点之间以固定的次序进行交换。持有令牌的节点有发送帧的权利，没有帧要发就立刻转交给下一个节点。

这个方法分散、效率高。他的缺点就是单个节点出故障也会整个信道崩溃，或者必须有帮助令牌释放的方法。

Bluetooth, FDDI, token ring.

---

### LANs 交换局域网

#### MAC address

其实又叫LAN地址，物理地址，MAC地址，链路层地址。

不是主机或路由器有这个，而是网络接口有这个链路层地址。所以有多个网络接口的主机也会有多个链路层地址。用于本地地去获取一个接口到另一个物理连接接口（同一个子网）的帧

48比特位，每8位组成一对十六进制数拼接成6字节。有时候也可以软件设置。以16进制做例子：1A-2F-BB-76-09-AD

#### Address Resolution Protocol(ARP)地址解析协议

因为存在网络层地址和链路层地址，所以需要对他们进行转换，这是ARP的任务

**在同一个子网上**、已知IP情况下，ARP模块可以将其解析为一个MAC地址。就像DNS将主机名解析为IP地址。工作原理就是主机或路由器中内存有一个ARP表，这张表包含映射关系还有TTL值。表项一般存活时间是20分钟。

如果发送方本地的ARP表有需要的数据那很方便，但没有的话就需要构造一个ARP packet，有查询的广播帧或者相应的响应标准帧，去询问子网上所有其他的主机和路由器来确定对应要解析的IP地址的MAC地址。

#### Routing to another subnet:发送数据报到子网以外

这个情况更为复杂，发送IP数据报时没有自己ARP模块去找到对方MAC地址。

简单地说就是去寻址自己所在子网的路由器适配器，然后被路由器传递到网络层。在查询路由器中的转发表后找到另一个子网的适配器地址（完成进入另一个子网），适配器2此时封装数据报到一个新的帧，帧的目的MAC地址就是靠这个子网中的ARP模块获得的正确目的MAC地址。

#### Ethernet以太网

不可靠，不连接。

有线局域网技术，第一个广泛部署的高速局域网。便宜简单，速率区间10Mbps-400Gbps

**hub集线器**：物理设备

**switch交换机**：中间的活动的链路层。

*以太网的帧结构：*

| 前同步码preamble | 目的地址dest address | 源地址src address | 类型type | 数据data(payload) | CRC  |
| ---------------- | -------------------- | ----------------- | -------- | ----------------- | ---- |

**前同步码(8字节)**：前7个字节都是10101010，最后是10101011，用于唤醒接收适配器，同步时钟。

**数据字段(46-1500字节)**：承载IP数据报。超过1500字节（MTU）要切片；过小也会被填充。

**目的地址(6字节)**：目的适配器的MAC地址

**源地址(6字节)**：传输该帧到局域网上的适配器的MAC地址

**类型字段(2字节)**：允许服用多种网络层协议

**CRC(4字节)**：检测用，[见上文](#Cyclic Redundancy Check (CRC)循环冗余码)

#### 链路层交换机Switches

一个链路层设备，很活跃。存储、转发以太网帧。检验传入帧的MAC地址，当有帧要被转发时有选择地转发帧到一个或多个传出链路。交换机对于节点时**transparent透明的**。意思是节点之间发生寻址一个帧，顺利的发送进局域网时不知道某个交换机会接受到并转发。多重同时传输

**转发Forwarding：**决定一个帧应该被导向哪个接口

**过滤Filtering:**	决定一个帧应该被转发还是应当将其丢弃

这两个功能依靠交换机表完成。该交换机中的表象包括地址接口和时间，

他是可以自学习的，转发表初始为空

#### VLANs

虚拟局域网。现实局域网有很多缺点：缺乏流量隔离，交换机的无效使用，管理用户。

VLAN没有这些问题，支持VLN的交换机允许经一个单一的物理局域网基础设施来定义多个虚拟局域网。在一个VLAN内的主机彼此通信，仿佛没有与交换机连接。

虚拟局域网是一种逻辑上把网络资源和网络用户按照一定的原则进行划分，把一个物理上实际的网络划分成多个小的逻辑网络的技术。小逻辑网各自形成广播域vlam.

拓展性互联VLAN交换机的方法：**VLAN trunkingVLAN(干线连接)**.每台交换机上的特殊端口配为干线端口，以互联两台VLAN交换机。它属于所有VLAN。

---

### Data center networking 数据中心网络

每个数据中心都容纳了数万到数十万台主机，并同时支撑很多不同的云应用。每个数据中心也有自己的数据中心网络，将其内部主机彼此互联并与因特网的数据中心互联。

挑战：可靠性，要有很多个应用，每个都服务超大量的客户端，平衡负载

**Load balancer**均衡负载器：向主机分发外部请求，以主机当前的负载作为函数在主机之间均衡负载。



### Web页面请求的历程

学完了，我们再来理解一下整个场景。、![image-20220608100620817](C:\Users\Tung\AppData\Roaming\Typora\typora-user-images\image-20220608100620817.png)

#### 准备DHCP, IP, UDP, 以太网

1. 便携机生成一个HDCP请求报文放入目的端口67（DHCP服务器）、源端口68（DHCP客户端）的UDP报文段。

2. 包含DHCP请求报文的IP数据报封装在以太网帧中，广播到和交换机连接的所有设备。
3. 路由器接收到这个帧，抽取出IP数据报。以太网分解这个数据报向上到达UDP，抽取其中的DHCP请求，DHCP获得了DCHCP请求报文。
4. DHCP服务器生成DHCP ACK，其中包含客户端的IP地址、客户端的第一跳路由器的IP地址、DNS服务器的名称和IP地址。
5. 在DHCP服务器上封装，通过LAN转发帧(交换机学习)，在客户端解复用。
6. DHCP客户端（便携机）收到包含DHCP ACK的回应

#### 然后是DNS, ARP

1. 需要访问www.baidu.com的IP地址，所以是用了DNS请求获取其ip
2. DNS查询已创建，封装在UDP中，封装在IP中，封装在Eth中。要将帧发送到路由器，需要路由器接口的MAC地址:得使用ARP协议。
3. 路由器收到的ARP查询广播，它会回复ARP回复，给出路由器接口的MAC地址
4. 客户端现在知道第一跳路由器的MAC地址，因此现在可以发送包含DNS查询的帧了。

#### 域内路由选择到 DNS服务器

1. 网关路由器接受该帧并抽取包含DNS查询的IP数据报，查找目的地址，根据转发表决定发送到某个路由器。
2. 那个路由器收到该帧，根据转发表确认出接口，经过他朝着DNS服务器转发数据表。转发表根据域内协议（可能是RIP,OSPF等）和域间协议BGP所填写。
3. 最后包含DNS查询的ip数据报就来到了DNS服务器，抽取查找报文，在DNS库中寻找www.baidu.com的ip地址放进IP数据报。再被commcast网络转发回校园路由器，经过以太网回到客户端。客户端得到ip地址

#### Web客户：服务器交互 TCP和HTTP

1. 为了发HTTP请求，客户端先打开和web server的TCP连接，执行三次握手
2. HTTP请求发到TCP套接字
3. 包含HTTP请求的IP数据报路由给www.baidu.com
4. web服务器以HTTP reply回应，包含着网页
5. 包含有HTTP回复的IP数据报路由回客户端







## L7 Wireless and Mobile Networks

**无线网络和移动网络**，也就是这两个重要挑战。

无线：通过无线链接进行通信

移动：处理改变网络连接点的移动用户

### 无线网络

#### 无线网络主要组件：

1. 无线主机（Wireless Host): 笔记本，手机...运行应用。和基站关联的主机通常称为基础设施模式infrastructure mode运行，
2. 基站(base station): 无线网络基础设施的关键部分。通常连接到有线网络中。负责在影响区域内的有线网络和无线主机之间发送数据包。比如蜂窝塔cell tower, 802.11 access points。
3. 无线链路wireless link：主机通过它连接到一个基站或者另一个无线主机。多址协议协调链路接入，有很多种速率、距离、频带。
4. 自组织网络 ad hoc network**： 没有基站**节点，只可以传输到链路中覆盖的其他节点。将自己组织成一个网络在他们之间路由。

#### 无线链路的特征

1. **decreased signal strength**信号强度下降：无线电信号在介质中传播衰减
2. **interference from other sources**来自其它来源的干扰：很多设备共享网络频率
3. **multipath propagation多路径传播**：从地面反射到达目的地的时间有点不同
4. **SNR(signal-to-noise ratio)信噪比：**更容易从噪声中提取信号，可能会因为移动性而更改，跟着物理层动态调整。给定物理层，增加功率，SNR增加，BER下降；给定SNR， 选择满足BER要求的物理层

####  Code Division Multiple Access (CDMA)码分多址接入

分配给每个用户的唯一代码，允许用户共享频率，但每个用户用自己的芯片序列编码数据；允许多个用户共存并同时传输最小干扰。

#### WIFI:802.11 wireless LANs

##### Basic Service Set(BSS)基本服务集

一个BSS包含一个或多个无线站点和一个接入点(Access Point)的中央基站。一个典型的家庭网络有一个AP和一台将该BSS连接到因特网的路由器。

##### Channels and association信道与关联

频谱分成不同的频率，AP管理员为他们选择频率。可能会受到的干扰：邻居AP可能选了一样的频率信道。到达主机：必须与AP相关联。监听包括AP名称和MAC地址的信标帧beacon frame。

#### Cellular Networks: 4G and 5G蜂窝网络

### Mobility

让终端系统来处理:“边缘”功能

1. 间接路由:从通信者到手机的通信通过本地网络，然后转发到远程手机
2. 直接路由:通信者获得手机的国外地址，直接发送到手机。